{% extends 'blog/base.html' %} {% block content %}
<article class="bg-white p-6 rounded shadow">
  {% if post.featured_image %}
  <img
    src="{{ post.featured_image.url }}"
    class="w-full h-64 object-cover rounded mb-4"
  />
  {% endif %}
  <h1 class="text-2xl font-bold">{{ post.title }}</h1>
  <p class="text-sm text-gray-600">
    By
    <a
      href="{% url 'blog:author_profile' post.author.username %}"
      class="underline"
      >{{ post.author.username }}</a
    >
    · {{ post.created_at|date:"F j, Y" }}
  </p>
  <div class="mt-4 prose">
    {% comment %} {{ post.content|linebreaks }} {% endcomment %}
    {{post.content|safe }}
  </div>

  <div class="mt-6 flex items-center gap-4">
    <span id="view-count" class="text-sm text-gray-600"
      >Views: {{ post.views }}</span
    >
    {% if user.is_authenticated and user != post.author %}
    <button
      id="follow-btn"
      data-username="{{ post.author.username }}"
      class="px-3 py-1 rounded border"
    >
      {% if is_following %} Unfollow {% else %} Follow {% endif %}
    </button>
    {% endif %}
  </div>

  <hr class="my-6" />

  <section id="comments" class="">
    <h3 class="font-semibold">
      Comments (<span class="comment-count">{{ post.comments.count }}</span>)
    </h3>
    <ul id="comment-list" class="mt-3 space-y-3">
      {% for comment in post.comments.all %}
      <li class="bg-gray-50 p-3 rounded">
        <p class="text-sm">
          <strong>{{ comment.author.username }}</strong> ·
          <span class="text-xs text-gray-500">{{ comment.created_at }}</span>
        </p>
        <p class="mt-1">{{ comment.body }}</p>
      </li>
      {% endfor %}
    </ul>

    {% if user.is_authenticated %}
    <form id="comment-form" class="mt-4">
      {% csrf_token %}
      <textarea
        name="body"
        id="comment-body"
        rows="3"
        class="w-full border rounded px-2 py-1"
        placeholder="Write a comment..."
      ></textarea>
      <button
        type="submit"
        class="mt-2 px-3 py-1 rounded bg-indigo-600 text-white"
      >
        Post comment
      </button>
    </form>
    {% else %}
    <p class="mt-2 text-sm">
      Please <a href="{% url 'login' %}">login</a> to comment.
    </p>
    {% endif %}
  </section>
</article>

<script>
  const commentCountSpan = document.querySelector(".comment-count");
  console.log("Before update:", commentCountSpan.textContent);
  // mark page with post slug for blog.js to pick up
  window.BLOG = window.BLOG || {};
  window.BLOG.postSlug = '{{ post.slug }}';
  window.BLOG.commentsCount= '{{post.comments.count}}';
  window.BLOG.authorUsername = '{{ post.author.username }}';
  window.BLOG.isFollowing = {{ is_following|default_if_none:False|yesno:"true,false" }};
</script>
{% endblock %}
